# =============================================================================
# FluxCode Multi-Host - App Node (FluxCode only)
# =============================================================================
# 目的：在“应用节点”服务器上仅运行 fluxcode，并将 8080 暴露给入口层（Caddy/Nginx）。
#
# 用法（在“应用节点”服务器上）：
#   cd deploy
#   cp .env.node.example .env
#   # 至少设置：
#   #   DATABASE_HOST=...         # PostgreSQL 所在服务器 IP/域名
#   #   REDIS_HOST=...            # Redis 所在服务器 IP/域名
#   #   POSTGRES_PASSWORD=...
#   #   REDIS_PASSWORD=...
#   #   JWT_SECRET=...            # 多实例必须一致
#   #   ADMIN_PASSWORD=...        # 建议固定
#   docker compose -f docker-compose.node.yml up -d
#
# 安全提示：
# - 该文件会把 8080 映射到宿主机；请用防火墙仅放行入口服务器（不要暴露公网）。
# =============================================================================

services:
  fluxcode:
    image: ${FLUXCODE_IMAGE:-duegin/fluxcode:latest}
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 100000
        hard: 100000
    ports:
      - "${NODE_BIND_HOST:-0.0.0.0}:${NODE_PORT:-8080}:8080"
    # 将工作目录设为 /app/data，确保 AUTO_SETUP 写出的 config.yaml/.installed 落在持久化卷中
    working_dir: /app/data
    volumes:
      - fluxcode_data:/app/data
    environment:
      # Auto Setup
      - AUTO_SETUP=true

      # Server Configuration
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8080
      - SERVER_MODE=${SERVER_MODE:-release}
      - RUN_MODE=${RUN_MODE:-standard}
      - WEB_TITLE=${WEB_TITLE:-FluxCode}

      # Database Configuration (PostgreSQL)
      - DATABASE_HOST=${DATABASE_HOST:?DATABASE_HOST is required}
      - DATABASE_PORT=${DATABASE_PORT:-5432}
      - DATABASE_USER=${POSTGRES_USER:-fluxcode}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - DATABASE_DBNAME=${POSTGRES_DB:-fluxcode}
      - DATABASE_SSLMODE=${DATABASE_SSLMODE:-disable}

      # Redis Configuration
      - REDIS_HOST=${REDIS_HOST:?REDIS_HOST is required}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:?REDIS_PASSWORD is required}
      - REDIS_DB=${REDIS_DB:-0}

      # Admin Account（建议固定，避免并发首启时生成多个“无效日志密码”）
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@fluxcode.local}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:?ADMIN_PASSWORD is required}

      # JWT Configuration（多实例必须一致）
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      - JWT_EXPIRE_HOUR=${JWT_EXPIRE_HOUR:-24}

      # Timezone
      - TZ=${TZ:-Asia/Shanghai}

      # Gemini OAuth Configuration
      - GEMINI_OAUTH_CLIENT_ID=${GEMINI_OAUTH_CLIENT_ID:-}
      - GEMINI_OAUTH_CLIENT_SECRET=${GEMINI_OAUTH_CLIENT_SECRET:-}
      - GEMINI_OAUTH_SCOPES=${GEMINI_OAUTH_SCOPES:-}
      - GEMINI_QUOTA_POLICY=${GEMINI_QUOTA_POLICY:-}

      # 可选：多实例时建议下调单实例的连接池，避免总连接数 = 实例数 x pool
      - DATABASE_MAX_OPEN_CONNS=${DATABASE_MAX_OPEN_CONNS:-20}
      - DATABASE_MAX_IDLE_CONNS=${DATABASE_MAX_IDLE_CONNS:-10}
      - REDIS_POOL_SIZE=${REDIS_POOL_SIZE:-128}
      - REDIS_MIN_IDLE_CONNS=${REDIS_MIN_IDLE_CONNS:-10}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  fluxcode_data:
    driver: local

