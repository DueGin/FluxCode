# =============================================================================
# FluxCode Docker Compose (Scale-ready)
# =============================================================================
# 这个 compose 文件用于“水平扩容后端”场景：
# - 引入 Caddy 作为唯一入口（对外只暴露一个端口）
# - fluxcode 不再直接映射宿主机端口，从而可以 docker compose --scale
#
# 使用方法：
#   cd deploy
#   cp .env.example .env
#   # 至少设置：
#   #   POSTGRES_PASSWORD=...
#   #   JWT_SECRET=...           # 所有实例必须一致（建议 openssl rand -hex 32）
#   #   ADMIN_PASSWORD=...       # 建议固定，避免并发首启时生成多个“无效日志密码”
#   docker compose -f docker-compose.scale.yml up -d --scale fluxcode=3
#
# 访问：
#   http://localhost:${SERVER_PORT:-8080}
#
# 注意：
# - docker-compose（非 swarm）只能在“单机”水平扩容；多机需要额外的上游 LB 或改用 Swarm/K8s
# =============================================================================

services:
  # ===========================================================================
  # Ingress / Load Balancer
  # ===========================================================================
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "${BIND_HOST:-0.0.0.0}:${SERVER_PORT:-8080}:8080"
    volumes:
      - ./Caddyfile.compose:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - fluxcode-network
    depends_on:
      fluxcode:
        condition: service_healthy

  # ===========================================================================
  # FluxCode Application (scale this service)
  # ===========================================================================
  fluxcode:
    image: ghcr.io/duegin/fluxcode:latest
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 100000
        hard: 100000
    volumes:
      - fluxcode_data:/app/data
    environment:
      # Auto Setup
      - AUTO_SETUP=true

      # Server Configuration
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8080
      - SERVER_MODE=${SERVER_MODE:-release}
      - RUN_MODE=${RUN_MODE:-standard}
      - WEB_TITLE=${WEB_TITLE:-FluxCode}

      # Database Configuration (PostgreSQL)
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_USER=${POSTGRES_USER:-fluxcode}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - DATABASE_DBNAME=${POSTGRES_DB:-fluxcode}
      - DATABASE_SSLMODE=disable

      # Redis Configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=${REDIS_DB:-0}

      # Admin Account (建议固定，避免并发首启时生成多个“无效日志密码”)
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@fluxcode.local}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:?ADMIN_PASSWORD is required}

      # JWT Configuration（多实例必须一致）
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      - JWT_EXPIRE_HOUR=${JWT_EXPIRE_HOUR:-24}

      # Timezone
      - TZ=${TZ:-Asia/Shanghai}

      # Gemini OAuth Configuration
      - GEMINI_OAUTH_CLIENT_ID=${GEMINI_OAUTH_CLIENT_ID:-}
      - GEMINI_OAUTH_CLIENT_SECRET=${GEMINI_OAUTH_CLIENT_SECRET:-}
      - GEMINI_OAUTH_SCOPES=${GEMINI_OAUTH_SCOPES:-}
      - GEMINI_QUOTA_POLICY=${GEMINI_QUOTA_POLICY:-}

      # 可选：多实例时建议下调单实例的连接池，避免总连接数 = 实例数 x pool
      - DATABASE_MAX_OPEN_CONNS=${DATABASE_MAX_OPEN_CONNS:-20}
      - DATABASE_MAX_IDLE_CONNS=${DATABASE_MAX_IDLE_CONNS:-10}
      - REDIS_POOL_SIZE=${REDIS_POOL_SIZE:-128}
      - REDIS_MIN_IDLE_CONNS=${REDIS_MIN_IDLE_CONNS:-10}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - fluxcode-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  postgres:
    image: postgres:18-alpine
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 100000
        hard: 100000
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-fluxcode}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - POSTGRES_DB=${POSTGRES_DB:-fluxcode}
      - TZ=${TZ:-Asia/Shanghai}
    networks:
      - fluxcode-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-fluxcode} -d ${POSTGRES_DB:-fluxcode}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ===========================================================================
  # Redis Cache
  # ===========================================================================
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 100000
        hard: 100000
    volumes:
      - redis_data:/data
    command: >
      redis-server
      --save 60 1
      --appendonly yes
      --appendfsync everysec
      ${REDIS_PASSWORD:+--requirepass ${REDIS_PASSWORD}}
    environment:
      - TZ=${TZ:-Asia/Shanghai}
      - REDISCLI_AUTH=${REDIS_PASSWORD:-}
    networks:
      - fluxcode-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

volumes:
  fluxcode_data:
    driver: local
  postgres_data:
    driver: local
  redis_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local

networks:
  fluxcode-network:
    driver: bridge

