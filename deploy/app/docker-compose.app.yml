# =============================================================================
# FluxCode Multi-Host - App (Caddy + FluxCode)
# =============================================================================
# 目的：把应用与入口部署在独立服务器上，并连接到“远端”的 PostgreSQL/Redis。
#
# 用法（在“应用/入口”服务器上）：
#   cd deploy
#   cp .env.app.example .env
#   # 至少设置：
#   #   DATABASE_HOST=...         # PostgreSQL 所在服务器 IP/域名
#   #   REDIS_HOST=...            # Redis 所在服务器 IP/域名
#   #   POSTGRES_PASSWORD=...
#   #   REDIS_PASSWORD=...
#   #   CADDY_ADDRESS=...         # 你的域名（推荐，自动启用 HTTPS）
#   #   JWT_SECRET=...            # 多实例必须一致
#   #   ADMIN_PASSWORD=...        # 建议固定
#   docker compose -f docker-compose.app.yml up -d
#
# 说明：
# - 该文件默认把 Caddy 放在容器里作为入口，对外暴露 80/443（可用 HTTP_PORT/HTTPS_PORT 调整）。
# - 如果你未来要把多个“应用节点”接到同一个入口，请编辑 Caddyfile.multihost 的 upstream 列表。
# =============================================================================

services:
  # ===========================================================================
  # Ingress / Load Balancer
  # ===========================================================================
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "${DOCKER_LOG_MAX_SIZE:-20m}"
        max-file: "${DOCKER_LOG_MAX_FILE:-5}"
    ports:
      # HTTP/HTTPS 入口（用于 Caddy 自动 HTTPS 证书申请与续期）
      - "${BIND_HOST:-0.0.0.0}:${HTTP_PORT:-80}:80"
      - "${BIND_HOST:-0.0.0.0}:${HTTPS_PORT:-443}:443"
    volumes:
      - ./Caddyfile.multihost:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      # 留空则使用 :80（仅 HTTP）；设置为域名后自动启用 HTTPS（需 80/443 可达）
      - CADDY_ADDRESS=${CADDY_ADDRESS:-:80}
      - TZ=${TZ:-Asia/Shanghai}
    networks:
      - fluxcode-network
    depends_on:
      fluxcode:
        condition: service_healthy

  # ==========================================================================
  # FluxCode Application
  # ==========================================================================
  fluxcode:
    image: ${FLUXCODE_IMAGE:-duegin/fluxcode:latest}
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "${DOCKER_LOG_MAX_SIZE:-20m}"
        max-file: "${DOCKER_LOG_MAX_FILE:-5}"
    ulimits:
      nofile:
        soft: 100000
        hard: 100000
    # 将工作目录设为 /app/data，确保 AUTO_SETUP 写出的 config.yaml/.installed 落在持久化卷中
    working_dir: /app/data
    volumes:
      - fluxcode_data:/app/data
    environment:
      # Auto Setup
      - AUTO_SETUP=true

      # Server Configuration
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8080
      - SERVER_MODE=${SERVER_MODE:-release}
      - RUN_MODE=${RUN_MODE:-standard}
      - WEB_TITLE=${WEB_TITLE:-FluxCode}

      # Database Configuration (PostgreSQL)
      - DATABASE_HOST=${DATABASE_HOST:?DATABASE_HOST is required}
      - DATABASE_PORT=${DATABASE_PORT:-5432}
      - DATABASE_USER=${POSTGRES_USER:-fluxcode}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - DATABASE_DBNAME=${POSTGRES_DB:-fluxcode}
      - DATABASE_SSLMODE=${DATABASE_SSLMODE:-disable}

      # Redis Configuration
      - REDIS_HOST=${REDIS_HOST:?REDIS_HOST is required}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:?REDIS_PASSWORD is required}
      - REDIS_DB=${REDIS_DB:-0}

      # Admin Account（建议固定，避免并发首启时生成多个“无效日志密码”）
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@fluxcode.local}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:?ADMIN_PASSWORD is required}

      # JWT Configuration（多实例必须一致）
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      - JWT_EXPIRE_HOUR=${JWT_EXPIRE_HOUR:-24}

      # Timezone
      - TZ=${TZ:-Asia/Shanghai}

      # Gemini OAuth Configuration
      - GEMINI_OAUTH_CLIENT_ID=${GEMINI_OAUTH_CLIENT_ID:-}
      - GEMINI_OAUTH_CLIENT_SECRET=${GEMINI_OAUTH_CLIENT_SECRET:-}
      - GEMINI_OAUTH_SCOPES=${GEMINI_OAUTH_SCOPES:-}
      - GEMINI_QUOTA_POLICY=${GEMINI_QUOTA_POLICY:-}

      # 可选：多实例时建议下调单实例的连接池，避免总连接数 = 实例数 x pool
      - DATABASE_MAX_OPEN_CONNS=${DATABASE_MAX_OPEN_CONNS:-20}
      - DATABASE_MAX_IDLE_CONNS=${DATABASE_MAX_IDLE_CONNS:-10}
      - REDIS_POOL_SIZE=${REDIS_POOL_SIZE:-128}
      - REDIS_MIN_IDLE_CONNS=${REDIS_MIN_IDLE_CONNS:-10}
    networks:
      - fluxcode-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  fluxcode_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local

networks:
  fluxcode-network:
    driver: bridge
